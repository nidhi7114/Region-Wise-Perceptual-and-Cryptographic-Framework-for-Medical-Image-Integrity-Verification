<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>{{ title }}</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        body { background-color: #f8f9fa; }
        .card { margin-top: 20px; }
        .file-input { margin-top: 10px; }
        .btn-upload, .btn-verify, .btn-simulate, .btn-api, .btn-batch { margin-top: 10px; }
        pre { background-color: #e9ecef; padding: 10px; border-radius: 5px; max-height: 200px; overflow-y: auto; }
    </style>
</head>
<body>
<div class="container mt-5">
    <h2 class="text-center">{{ title }}</h2>

    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        <div class="mt-3">
            {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        </div>
    {% endif %}
    {% endwith %}

    <div class="row">
        <!-- Upload Image Card -->
        <div class="col-md-3">
            <div class="card">
                <div class="card-header">Upload Image for Signing</div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('upload_image') }}" enctype="multipart/form-data">
                        <input type="file" name="image" class="form-control file-input" required>
                        <button type="submit" class="btn btn-success btn-upload">Upload & Sign</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Verify Image Card -->
        <div class="col-md-3">
            <div class="card">
                <div class="card-header">Verify Uploaded Image</div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('verify_image') }}" enctype="multipart/form-data">
                        <input type="file" name="image" class="form-control file-input" required>
                        <button type="submit" class="btn btn-primary btn-verify">Verify</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Tamper Simulation Card -->
        <div class="col-md-3">
            <div class="card">
                <div class="card-header">Simulate Tamper</div>
                <div class="card-body">
                    {% if uploaded_files %}
                        <select id="tamper_filename" class="form-control file-input">
                            <option value="">Select a file to tamper</option>
                            {% for f in uploaded_files %}
                                <option value="{{ f }}">{{ f }}</option>
                            {% endfor %}
                        </select>
                    {% else %}
                        <input type="text" id="tamper_filename" placeholder="Enter filename to tamper" class="form-control file-input" required>
                    {% endif %}
                    <button class="btn btn-warning btn-simulate mt-2">Simulate Tamper</button>
                    <small class="text-muted">Use exact uploaded filename.</small>
                </div>
            </div>
        </div>

        <!-- REST API Verification Card -->
        <div class="col-md-3">
            <div class="card">
                <div class="card-header">API Verification</div>
                <div class="card-body">
                    <input type="file" id="api_image" class="form-control file-input" required>
                    <button class="btn btn-info btn-api mt-2" onclick="verifyAPI()">Verify via API</button>
                    <div id="api_result" class="mt-2"></div>
                </div>
            </div>
        </div>

        <!-- Batch Verification Card -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">Batch Verification</div>
                <div class="card-body">
                    <form id="batch_form" method="POST" action="{{ url_for('batch_upload') }}" enctype="multipart/form-data">
                        <label>Original Images:</label>
                        <input type="file" name="original_images" multiple class="form-control file-input" required>
                        <label class="mt-2">Tampered Images:</label>
                        <input type="file" name="tampered_images" multiple class="form-control file-input" required>
                        <button type="submit" class="btn btn-dark btn-batch mt-2 w-100">Upload & Run Batch Verification</button>
                    </form>
                    <div id="batch_result" class="mt-3"><pre>No batch run yet...</pre></div>
                </div>
            </div>
        </div>

<script>
    // REST API verification with table output
    async function verifyAPI() {
        const fileInput = document.getElementById('api_image');
        const resultBox = document.getElementById('api_result');
        if (!fileInput.files.length) {
            alert("Select an image first!");
            return;
        }

        const formData = new FormData();
        formData.append('image', fileInput.files[0]);

        resultBox.innerHTML = "<p class='text-muted'>⏳ Verifying...</p>";

        try {
            const response = await fetch('/verify_api', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();

            let resultHTML = `
                <h5>Verification Result</h5>
                <table class="table table-bordered table-sm">
                    <tr><th>Uploaded File</th><td>${data.uploaded || "N/A"}</td></tr>
                    <tr><th>Reference File</th><td>${data.reference || "N/A"}</td></tr>
                    <tr><th>Tampered?</th><td style="color:${data.tampered ? 'red' : 'green'};">
                        ${data.tampered ? "Yes ❌" : "No ✅"}
                    </td></tr>
                    <tr><th>Hamming Distance</th><td>${data.hamming_distance ?? "N/A"}</td></tr>
                </table>
            `;

            if (data.region_status && data.region_status.length > 0) {
                resultHTML += `
                    <h6>Region-wise Comparison</h6>
                    <table class="table table-bordered table-sm">
                        <thead><tr><th>Region Hash</th><th>Status</th></tr></thead><tbody>
                        ${data.region_status.map(r => `
                            <tr>
                                <td>${r.hash}</td>
                                <td style="color:${r.status === 'match' ? 'green' : 'red'};">${r.status}</td>
                            </tr>
                        `).join("")}
                        </tbody>
                    </table>
                `;
            }

            resultBox.innerHTML = resultHTML;

        } catch (err) {
            resultBox.innerHTML = `<p class="text-danger">❌ API Error: ${err.message}</p>`;
        }
    }

    // Simulate Tamper
    document.querySelector('.btn-simulate').addEventListener('click', async function(e) {
        e.preventDefault();
        const filenameElem = document.getElementById('tamper_filename');
        const filename = filenameElem.value.trim();
        if (!filename) {
            alert("Select or enter a filename!");
            return;
        }

        try {
            const formData = new FormData();
            formData.append('filename', filename);

            const response = await fetch('/simulate_tamper', {
                method: 'POST',
                body: formData
            });

            if (response.redirected) {
                window.location.href = response.url;
            } else if (response.ok) {
                const html = await response.text();
                document.open();
                document.write(html);
                document.close();
            } else {
                alert("Error simulating tamper: " + response.statusText);
            }
        } catch (err) {
            alert("Error: " + err);
        }
    });

    // Batch Verification
    async function runBatch() {
        const resultDiv = document.getElementById("batch_result");
        resultDiv.innerHTML = "<pre>⏳ Running batch verification...</pre>";

        try {
            const response = await fetch("/batch_run", { method: "POST" });
            const data = await response.json();

            let table = '<table class="table table-bordered table-sm mt-2">';
            table += '<thead><tr><th>Attack</th><th>Total</th><th>SHA Accuracy</th><th>pHash Accuracy</th><th>Avg Runtime (s)</th></tr></thead><tbody>';

            for (const atk of data) {
                table += `<tr>
                    <td>${atk.Attack}</td>
                    <td>${atk.Total}</td>
                    <td>${(atk.SHA_Accuracy*100).toFixed(2)}%</td>
                    <td>${(atk.pHash_Accuracy*100).toFixed(2)}%</td>
                    <td>${atk.Avg_Runtime.toFixed(4)}</td>
                </tr>`;
            }
            table += '</tbody></table>';

            resultDiv.innerHTML = table;
        } catch (err) {
            resultDiv.innerHTML = "<pre>❌ Error: " + err + "</pre>";
        }
    }
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
